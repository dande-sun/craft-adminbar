{% set color = color ?? '#d85b4b' %}
{% set devMode = craft.app.config.general.devMode %}
{% set sticky = sticky ?? true %}
{% set type = type ?? 'primary' %}
{% set useCss = useCss ?? true %}
{% set useJs = useJs ?? true %}
{% set localesEnabled = localesEnabled ?? false %}

{% from _self import addConfigLink %}

<div class="adminbar{% if sticky %} adminbar--sticky{% endif %}{% if devMode %} adminbar--devmode{% endif %}{% if enableMobileMenu %} adminbar--mobile{% endif %}{% if scrollLinks %} adminbar--scroll_links{% endif %}">

    {% if devMode %}
        <div class="adminbar__devmode_indicator"></div>{% endif %}

    {% if displayGreeting %}
        <div class="adminbar__greeting">
            {% if currentUser.photo %}<span class="adminbar__user_photo">
                <img src="{{ currentUser.getThumbUrl(40) }}" alt="{{ currentUser.friendlyName }}â€™s photo"/>
                </span>{% endif %}{{ 'Hi'|t }}, {{ currentUser.friendlyName }}
        </div>
    {% endif %}

    <div id="adminbar__links" class="adminbar__links_wrapper adminbar__overlay">
        <nav class="adminbar__links">
            {% if displayDashboardLink %}
                <a href="{{ url(craft.app.config.general.cpTrigger ~ '/dashboard') }}" class="adminbar__has_icon"><span class="adminbar__icon"><svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 228.47 193.88"><defs><style>.cls-1{fill:#fff}</style></defs><path class="cls-1" d="M125.92 97.18a18.93 18.93 0 0 0-7.92-4.75L57 55.88l37.48 60.79a19 19 0 1 0 31.48-19.49z"/><path class="cls-1" d="M114.24 0C51.15 0 0 51.33 0 114.42a115.09 115.09 0 0 0 17.8 61.45c4.25 6 11.17 18 21.67 18h148c10.5 0 18.95-12 23.2-18A114.54 114.54 0 0 0 114.24 0zM40.63 175.88a96.86 96.86 0 0 1-22.16-61.51 95.76 95.76 0 1 1 169.37 61.51z"/></svg></span>{{ 'Dashboard'|t }}</a>
            {% endif %}

            {% if entry ?? false %}
                {% set sectionName = entry.section %}
                {% if localesEnabled %}
                    {% set entryEditUrl = entry.cpEditUrl ~ '/' ~ entry.locale %}
                {% else %}
                    {% set entryEditUrl = entry.cpEditUrl %}
                {% endif %}

                <a href="{{ url(entryEditUrl) }}" class="adminbar__has_icon"><span class="adminbar__icon"><svg data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 228.93 228.72"><path d="M227.35 48.35a14.64 14.64 0 0 0-2.79-17L197.84 4.58a15.47 15.47 0 0 0-17.42-3.17l-5.95 4.74L14.29 166.33 0 228.72l62.39-14.29L222.57 54.26zM32.59 210.92a30 30 0 0 0-14.84-14.58l5.53-24.15 14.14 6.91 13.06 13.06 6.86 13z" fill="#fff"/></svg></span>{{ 'Edit '|t ~ sectionName }}
                </a>
            {% endif %}

            {% if category ?? false %}
                {% if localesEnabled %}
                    {% set categoryEditUrl = category.cpEditUrl ~ '/' ~ category.locale %}
                {% else %}
                    {% set categoryEditUrl = category.cpEditUrl %}
                {% endif %}

                <a href="{{ url(categoryEditUrl) }}" class="adminbar__has_icon"><span class="adminbar__icon"><svg data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 228.93 228.72"><path d="M227.35 48.35a14.64 14.64 0 0 0-2.79-17L197.84 4.58a15.47 15.47 0 0 0-17.42-3.17l-5.95 4.74L14.29 166.33 0 228.72l62.39-14.29L222.57 54.26zM32.59 210.92a30 30 0 0 0-14.84-14.58l5.53-24.15 14.14 6.91 13.06 13.06 6.86 13z" fill="#fff"/></svg></span>{{ 'Edit '|t ~ category }}
                </a>
            {% endif %}

            {% if customLinks|length %}
                {% cache globally using key "adminbar" ~ currentUser.id if cacheBar %}
                {% for link in customLinks %}
                    {% if link.linkUrl|length %}
                        {% if link.adminOnly != true %}
                            <a href="{{ url(link.linkUrl) }}">{{ link.linkLabel|t }}</a>
                        {% elseif link.adminOnly and currentUser.admin %}
                            <a href="{{ url(link.linkUrl) }}">{{ link.linkLabel|t }}</a>
                        {% endif %}
                    {% endif %}
                {% endfor %}
                {% endcache %}
            {% endif %}

            {% for link in additionalLinks %}
                {{ addConfigLink(link) }}
            {% endfor %}

            {% if currentUser.admin and displaySettingsLink %}
                <a href="{{ url(craft.app.config.general.cpTrigger ~ '/settings') }}" class="adminbar__has_icon"><span class="adminbar__icon"><svg data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><path d="M240 135v-30.5l-35.93-15-2.75-8.5 15-34.87-21.45-21.63L158.63 39l-8.25-3.75L134.64 0h-29.5L90.06 35.55 82 38.84l-36.67-13.9L24 46.38 39.55 81l-4 9L0 105v30l35.82 14.75 4 9-14.72 35.5L46.37 215l35.76-14.5 8.75 4 14.76 35.5h30l14.74-36.25 8.49-3.25 35.74 14.75L216.09 194l-14.55-36 3.27-8.5zm-119.55 30.13a45.25 45.25 0 1 1 45.25-45.25 45.25 45.25 0 0 1-45.25 45.25z" fill="#fff"/></svg></span>{{ 'Settings'|t }}
                </a>
            {% endif %}
        </nav>
        <div class="adminbar__close">{{ 'Close'|t }}</div>
    </div>
    <div class="adminbar__logout">
        {% if displayLogout %}
            <a class="adminbar__logout_link" href="{{ url(logoutUrl) }}">{{ 'Logout'|t }}</a>
        {% endif %}
        {% if enableMobileMenu %}
            <div id="adminbar__mobile_toggle" class="adminbar__mobile_toggle">{{ 'Admin'|t }}</div>
        {% endif %}
    </div>
</div>

{% if not barEmbedded %}
    {% if useCss %}
        {% set newCss %}
            :root{--adminbar-color-white:#fff;--adminbar-color-black:#000;--adminbar-color-gray-dark:#505050;--adminbar-color-gray-light:#f5f5f5;--adminbar-color-bg:rgba(0,0,0,0.8);--adminbar-color-greeting:rgba(255,255,255,0.8);--adminbar-color-highlight:#d85b4b;--adminbar-color-text:#fff;--adminbar-font-size:17px}.adminbar__icon{display:inline-block;margin-right:5px;width:15px;-webkit-transform:translateY(2px);transform:translateY(2px)}.adminbar__icon svg{width:100%}@media screen and (max-width: 600px){.adminbar .adminbar__icon{margin-right:7px;width:22px}}.adminbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-flow:row nowrap;flex-flow:row nowrap;-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;position:relative;margin:0;padding:0;width:100%;-webkit-box-sizing:border-box;box-sizing:border-box;background-color:var(--adminbar-color-bg);font-family:"BlinkMacSystemFont",-apple-system,"Trebuchet MS","Lucida Grande","Lucida Sans Unicode","Lucida Sans",Tahoma,sans-serif;font-size:var(--adminbar-font-size);color:var(--adminbar-color-white);z-index:100000}.adminbar--sticky{position:fixed;top:0;left:0}.adminbar--devmode{padding-top:4px}.adminbar a{margin:0;padding:9px 10px;text-align:center;text-decoration:none;-webkit-transition:color .2s ease-out, background .2s ease-out;transition:color .2s ease-out, background .2s ease-out}.adminbar a svg path{-webkit-transition:fill .2s ease-out;transition:fill .2s ease-out}.adminbar__devmode_indicator{display:block;position:absolute;top:0;left:0;height:4px;width:100%;background:url("data:image/svg+xml;base64,PHN2ZyBpZD0iTGF5ZXJfMSIgZGF0YS1uYW1lPSJMYXllciAxIiB4bWxucz0iaHR0cDovL3d3dy5\a   3My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMjguNDcgMjIuOTUiPjxkZWZzPjxzdHlsZT\a   4uY2xzLTF7ZmlsbDojZjNiNjM4fTwvc3R5bGU+PC9kZWZzPjx0aXRsZT5kZXZtb2RlPC90aXRsZ\a   T48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0xODUuNTIgMGgtMTIwTDQyLjk1IDIyLjk1aDEyMEwx\a   ODUuNTIgMHoiLz48L3N2Zz4=") repeat-x 15px 0}.adminbar__greeting{display:none;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:0 0 auto;padding:0 15px;color:var(--adminbar-color-greeting);white-space:nowrap}.adminbar--mobile .adminbar__greeting{display:-webkit-box;display:-ms-flexbox;display:flex}.adminbar__user_photo{padding-right:7px;width:23px;line-height:0}.adminbar__user_photo img{max-width:100%;height:auto;border-radius:50%}.adminbar__links_wrapper{-webkit-box-flex:1;-ms-flex:1 1 auto;flex:1 1 auto;min-width:1px}.adminbar--active .adminbar__links_wrapper{overflow:scroll}.adminbar__links{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-flow:row wrap;flex-flow:row wrap;padding:0}.adminbar--mobile .adminbar__links{display:none}.adminbar--mobile .adminbar--active .adminbar__links{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column nowrap;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding:40px;min-height:100%;-webkit-box-sizing:border-box;box-sizing:border-box;font-size:1.4em}.adminbar__links a{-webkit-box-flex:0;-ms-flex:0 0 auto;flex:0 0 auto;color:var(--adminbar-color-text)}.adminbar__links a svg path{fill:var(--adminbar-color-text)}.adminbar__logout{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-ms-flex-item-align:end;align-self:flex-end;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column nowrap;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:0 0 auto;padding:0;text-align:right;font-size:.9em}.adminbar__logout a{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-flex:1;-ms-flex:1 1 auto;flex:1 1 auto;padding:9px 25px;background-color:transparent;-webkit-transition:background .2s ease-out, color .2s ease-out;transition:background .2s ease-out, color .2s ease-out;color:var(--adminbar-color-text)}.adminbar__logout a:hover{background-color:var(--adminbar-color-highlight);color:var(--adminbar-color-white)}.adminbar--mobile .adminbar__logout_link{display:none}.adminbar__mobile_toggle{display:none;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-flex:1;-ms-flex:1 1 auto;flex:1 1 auto;padding:12px 25px;font-size:1.1em}.adminbar--mobile .adminbar__mobile_toggle{display:block}.adminbar__overlay.adminbar--active{position:fixed;top:0;left:0;width:100%;height:100%;-webkit-box-sizing:border-box;box-sizing:border-box;background-color:var(--adminbar-color-highlight);overflow:auto}.adminbar__overlay>.adminbar__close{display:none;position:fixed;top:0;right:0;padding:12px 25px;font-size:1.1em}.adminbar__overlay.adminbar--active>.adminbar__close{display:block}@media screen and (min-width: 601px){.adminbar{font-size:14px}.adminbar__greeting{display:-webkit-box;display:-ms-flexbox;display:flex}.adminbar--scroll_links .adminbar__greeting{border-right:1px solid var(--adminbar-color-gray-dark)}.adminbar--mobile .adminbar__links{display:-webkit-box;display:-ms-flexbox;display:flex}.adminbar--scroll_links .adminbar__links{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-flow:row nowrap;flex-flow:row nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;-ms-overflow-style:-ms-autohiding-scrollbar}.adminbar__links a:hover{background-color:var(--adminbar-color-white);color:var(--adminbar-color-highlight)}.adminbar__links a:hover svg path{fill:var(--adminbar-color-highlight)}.adminbar__logout{-ms-flex-item-align:stretch;align-self:stretch;font-size:1em}.adminbar__logout a{padding:9px 25px}.adminbar--mobile .adminbar__logout_link{display:-webkit-box;display:-ms-flexbox;display:flex}.adminbar__scroll_links .adminbar__logout_link{border-left:1px solid var(--adminbar-color-gray-dark)}.adminbar--mobile .adminbar__mobile_toggle{display:none}}

            :root {
                --adminbar-color-bg: rgba({{ bgColor }}, .8);
                --adminbar-color-greeting: rgba({{ textColor }}, .8);
                --adminbar-color-highlight: rgb({{ highlightColor }});
                --adminbar-color-text: rgb({{ textColor }});
            }
        {% endset %}
        {% css newCss %}
    {% endif %}

    {% if useJs %}
        {% set js = '' %}
        {% set newJs %}
            "use strict";function adminBarShowMobile(e){var a=document.getElementById("adminbar__links");a.classList?a.classList.add("adminbar--active"):a.className+=" adminbar--active"}function adminBarHideMobile(e){var a=document.getElementById("adminbar__links");a.classList?a.classList.remove("adminbar--active"):a.className=a.className.replace(new RegExp("(^|\\b)"+className.split(" ").join("|")+"(\\b|$)","gi")," ")}document.getElementById("adminbar__mobile_toggle").addEventListener("click",adminBarShowMobile);for(var adminBarCloseButtons=document.querySelectorAll(".adminbar__overlay .adminbar__close"),i=0;i<adminBarCloseButtons.length;i++)adminBarCloseButtons[i].addEventListener("click",adminBarHideMobile);document.documentElement.classList?document.documentElement.classList.add("adminbar-on"):document.documentElement.className+=" adminbar-on";
        {% endset %}
        {% set js = js ~ newJs %}

        {% if js|length %}
            {% js js|raw %}
        {% endif %}
    {% endif %}
{% endif %}

{% macro addConfigLink(link) %}
    {% if link.linkParams is defined %}
        {% set params = link.linkParams %}
    {% else %}
        {% set params = '' %}
    {% endif %}

    {% set params = link.params ?? '' %}
    {% set protocol = link.protocol ?? '' %}
    {% set mustShowScriptName = link.mustShowScriptName ?? '' %}

    {% set userHasPermission = true %}
    {% if link.admin is defined and link.admin %}
        {% if not currentUser.admin %}
            {% set userHasPermission = false %}
        {% endif %}
    {% elseif link.permissions is defined and link.permissions|length %}
        {% for permission in link.permissions %}
            {% if not currentUser.can(permission) %}
                {% set userHasPermission = false %}
            {% endif %}
        {% endfor %}
    {% endif %}

    {% if link.type == 'url' and userHasPermission %}
        <a href="{{ url(link.url, params, protocol, mustShowScriptName) }}">{{ link.title|t }}</a>
    {% elseif link.type == 'cpUrl' and userHasPermission %}
        <a href="{{ url(craft.app.config.general.cpTrigger ~ '/' ~ link.url, params, protocol, mustShowScriptName) }}">{{ link.title|t }}</a>
    {% elseif link.type == 'action' and userHasPermission %}
        {% set actionParams = params|length ? params ~ '&returnUrl=' ~ craft.request.url : 'returnUrl=' ~ craft.request.url %}
        <a href="{{ actionUrl(link.url, actionParams) }}">{{ link.title|t }}</a>
    {% endif %}
{% endmacro %}